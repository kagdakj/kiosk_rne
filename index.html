<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í‚¤ì˜¤ìŠ¤í¬ ë¯¸ë‹ˆ í”„ë¦¬ë·° (Scaled)</title>
  <style>
    :root {
      --uiScale: 0.75;
      /* ì „ì²´ UI ì¶•ì†Œ ë°°ìœ¨ (0.5 ~ 1.25 ê¶Œì¥) */
      --frameW: 950px;
      /* ì›ë³¸ ì•±ì˜ ê¸°ì¤€ ë„ˆë¹„ */
      --frameH: 640px;
      /* ì›ë³¸ ì•±ì˜ ê¸°ì¤€ ë†’ì´(ë³´ì´ëŠ” ì˜ì—­) */
      --bg: #0b0b0c;
      --fg: #f5f5f7;
      --muted: #9aa0a6;
      --accent: #2563eb;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 10px 14px;
      background: #121214;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    header h1 {
      font-size: 1rem;
      margin: 0;
    }

    .sp {
      flex: 1;
    }

    .btn {
      cursor: pointer;
      border: 1px solid #34363a;
      background: #1b1d22;
      color: #e6e6ea;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
    }

    .btn.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }

    input[type="range"] {
      width: 200px;
    }

    /* ë¯¸ë‹ˆ í”„ë ˆì„ ë˜í¼: í™”ë©´ ì¤‘ì•™ ë°°ì¹˜ */
    .wrap {
      min-height: calc(100vh - 56px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .frame {
      position: relative;
      width: calc(var(--frameW) * var(--uiScale));
      height: calc(var(--frameH) * var(--uiScale));
      border-radius: 18px;
      box-shadow: 0 14px 38px rgba(0, 0, 0, .45), 0 6px 18px rgba(0, 0, 0, .35);
      background: #0f0f11;
    }

    .chrome {
      position: absolute;
      inset: 0;
      pointer-events: none;
      border: 1px solid #2a2a2a;
      border-radius: 18px;
    }

    .scale-shell {
      position: absolute;
      left: 0;
      top: 0;
      transform-origin: top left;
      transform: scale(var(--uiScale));
      width: calc(var(--frameW));
      height: calc(var(--frameH));
      overflow: hidden;
    }

    .note {
      color: var(--muted);
      font-size: .9rem;
    }

    /* ===== ì›ë³¸ í‚¤ì˜¤ìŠ¤í¬ ì•±(ì²˜ìŒ ë§Œë“  ë²„ì „)ì„ ë‚´ì¥ ===== */
    /* í•µì‹¬: ì›ë³¸ì€ ê°€ê¸‰ì  ìˆ˜ì •í•˜ì§€ ì•Šê³ , ì•„ë˜ #appRootë¥¼ í†µì§¸ë¡œ scale-shell ì•ˆì— ë„£ëŠ”ë‹¤ */

    /* ì›ë³¸ ìŠ¤íƒ€ì¼(ìš”ì•½ë³¸) */
    .app header {
      position: sticky;
      top: 0;
      background: #fff;
      color: #111;
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .app header .title {
      font-weight: 900;
    }

    .app main {
      max-width: 980px;
      margin: 0 auto;
      padding: 14px;
      font-size: 16px;
    }

    .app .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .app .sp {
      flex: 1;
    }

    .app .btn {
      cursor: pointer;
      user-select: none;
      border: none;
      border-radius: 14px;
      font-weight: 800;
      padding: 12px 16px;
      background: #2563eb;
      color: #fff;
    }

    .app .btn.ghost {
      background: #f3f4f6;
      color: #111;
      border: 1px solid #e5e7eb;
    }

    .app .card {
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px;
    }

    .app .grid {
      display: grid;
      gap: 12px;
    }

    .app .cols-2 {
      grid-template-columns: 1.2fr .8fr;
    }

    .app .items {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .app .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: #fff;
      color: #111;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px;
      min-height: 72px;
    }

    .app .chip {
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 8px 12px;
      background: #fff;
      color: #111;
      font-weight: 700;
    }

    .app .chip.on {
      background: #2563eb;
      color: #fff;
      border-color: transparent;
    }

    .app .sticky-btm {
      position: sticky;
      bottom: 0;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      padding: 10px 0;
    }

    @media (max-width: 980px) {
      :root {
        --frameW: 840px;
        --frameH: 620px;
      }
    }

    @media (max-width: 860px) {
      :root {
        --frameW: 720px;
        --frameH: 600px;
      }
    }

    @media (max-width: 740px) {
      :root {
        --frameW: 560px;
        --frameH: 560px;
      }
    }

    @media (max-width: 600px) {
      :root {
        --frameW: 520px;
        --frameH: 560px;
      }
    }

    /* ==== Vertical anchor movement (top/middle/bottom) with smooth animation ==== */
    .wrap {
      min-height: calc(100vh - 56px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .frame {
      position: relative;
      width: calc(var(--frameW) * var(--uiScale));
      height: calc(var(--frameH) * var(--uiScale));
      border-radius: 18px;
      box-shadow: 0 14px 38px rgba(0, 0, 0, .45), 0 6px 18px rgba(0, 0, 0, .35);
      background: #0f0f11;
      will-change: transform;
    }

    .anchor-indicator {
      pointer-events: none;
      position: fixed;
      left: 12px;
      bottom: 12px;
      color: var(--muted);
      font-size: .9rem;
    }

    /* ===== ì—°ë ¹ë³„ ëª¨ë“œ ìŠ¤íƒ€ì¼ ===== */
    /* ê³µí†µ: bodyì— age-* í´ë˜ìŠ¤ë¥¼ ë¶™ì´ë©´ ì „ì²´ UIì— ì ìš©ë©ë‹ˆë‹¤ */
    body.age-child {
      --accent: #ff6b6b;
      font-size: 18px;
    }

    body.age-teen {
      --accent: #7c3aed;
      font-size: 15px;
    }

    body.age-adult {
      --accent: #2563eb;
      font-size: 16px;
    }

    body.age-senior {
      --accent: #0b6623;
      font-size: 20px;
    }

    /* ì–´ë¦°ì´: í™”ë ¤í•˜ê³  í¼ì§í•œ ë²„íŠ¼ */
    body.age-child .app .item {
      background: linear-gradient(135deg, #fff8f0, #fff1f3);
      border-color: #ffd6d6;
      font-size: 1.15rem;
      padding: 18px;
      border-radius: 16px;
    }

    body.age-child .app .btn {
      border-radius: 18px;
      padding: 14px 18px;
      font-size: 1.05rem;
      background: var(--accent);
    }

    /* ì²­ì†Œë…„: ëª¨ë˜í•œ ì»¬ëŸ¬, ì•½ê°„ ë” ì´˜ì´˜í•œ ë ˆì´ì•„ì›ƒ */
    body.age-teen .app .item {
      font-size: 1.05rem;
    }

    body.age-teen .app .btn {
      padding: 12px 16px;
    }

    /* ë…¸ì¸: ê³ ëŒ€ë¹„, í° ê¸€ì, í° ë²„íŠ¼ */
    body.age-senior {
      background: #080808;
    }

    body.age-senior .app .card {
      background: #fff;
      color: #000;
      border-color: #bbb;
    }

    body.age-senior .app header,
    body.age-senior .app .item,
    body.age-senior .app .btn {
      font-size: 1.25rem;
    }

    body.age-senior .app .btn {
      padding: 16px 20px;
      border-radius: 16px;
    }

    /* ì—°ë ¹ ì„ íƒ ëª¨ë‹¬ */
    .age-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.6);
      z-index: 1000;
    }

    .age-modal[aria-hidden="true"] {
      display: none;
    }

    .age-card {
      width: 320px;
      max-width: 94%;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .6);
    }

    .age-card .chip {
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
    }

    @media (min-width:900px) {
      .age-card {
        width: 420px;
      }
    }

    /* ì¹´ë©”ë¼ ì˜¤ë²„ë ˆì´ */
    .cam-overlay {
      position: fixed;
      right: 12px;
      top: 80px;
      width: 240px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 12px;
      padding: 8px;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cam-overlay video {
      width: 100%;
      height: auto;
      border-radius: 8px;
      background: #000;
    }

    .cam-overlay canvas {
      display: none;
    }

    .cam-overlay .note {
      color: #ddd;
      font-size: .85rem;
    }

    .cam-hidden {
      display: none !important;
    }

    /* ìŒì„± ì¸ì‹ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .voice-btn {
      position: relative;
    }

    .voice-btn.recording {
      background: #ef4444 !important;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .voice-status {
      position: fixed;
      left: 12px;
      top: 80px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 0.9rem;
      z-index: 1200;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .voice-status.hidden {
      display: none;
    }
  </style>
</head>
<!-- face-api.js (ë¸Œë¼ìš°ì €ì—ì„œ ëª¨ë¸ ê¸°ë°˜ ì¶”ì •ì„ í•˜ë ¤ë©´ í•„ìš”) -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<body>
  <header>
    <h1>í‚¤ì˜¤ìŠ¤í¬ ë¯¸ë‹ˆ í”„ë¦¬ë·°</h1>
    <div class="sp"></div>
    <label>ë°°ìœ¨ <input id="scale" type="range" min="0.50" max="1.25" step="0.01" value="0.75" /></label>
    <button class="btn" data-z="0.50">50%</button>
    <button class="btn" data-z="0.75">75%</button>
    <button class="btn" data-z="1.00">100%</button>
    <button class="btn" data-z="1.10">110%</button>
    <div class="sp"></div>
    <button class="btn" id="anchorTop" title="ìœ„ë¡œ">ìœ„ë¡œ</button>
    <button class="btn" id="anchorMid" title="ê°€ìš´ë°">ê°€ìš´ë°</button>
    <button class="btn" id="anchorBot" title="ì•„ë˜ë¡œ">ì•„ë˜ë¡œ</button>
    <button class="btn primary" id="anchorAuto" title="ìë™">ìë™</button>
    <button class="btn" id="changeAgeBtn" title="ì—°ë ¹ ë³€ê²½">ì—°ë ¹</button>
    <button class="btn" data-z="0.50">50%</button>
    <button class="btn" id="autoAgeCamBtn" title="ì¹´ë©”ë¼ ìë™ì—°ë ¹">ì¹´ë©”ë¼ ìë™ì—°ë ¹</button>
    <button class="btn voice-btn" id="voiceBtn" title="ìŒì„± ì£¼ë¬¸">ğŸ¤ ìŒì„±</button>
    <button class="btn" data-z="0.75">75%</button>
    <button class="btn" data-z="1.00">100%</button>
    <button class="btn" data-z="1.10">110%</button>
  </header>

  <!-- ì—°ë ¹ ì„ íƒ/ë³€ê²½ ëª¨ë‹¬ -->
  <div id="ageModal" class="age-modal" aria-hidden="true">
    <div class="age-card card" role="dialog" aria-labelledby="ageTitle">
      <h3 id="ageTitle" style="margin:0 0 8px 0;">ì—°ë ¹ëŒ€ ì„ íƒ</h3>
      <p class="note" style="margin:0 0 12px 0;">ìƒë…„ì„ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì„ íƒí•˜ì„¸ìš”.</p>
      <div class="row" style="gap:8px; align-items:center;">
        <input id="birthYear" type="number" min="1900" max="2025" placeholder="ì˜ˆ: 1990"
          style="flex:1; padding:10px; font-size:1rem;" />
        <button class="btn" id="ageApply">ì ìš©</button>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="chip" data-age="child">ì–´ë¦°ì´</button>
        <button class="chip" data-age="teen">ì²­ì†Œë…„</button>
        <button class="chip" data-age="adult">ì„±ì¸</button>
        <button class="chip" data-age="senior">ë…¸ì¸</button>
      </div>
      <div style="margin-top:12px; text-align:right;">
        <button class="btn ghost" id="ageSkip">ê±´ë„ˆë›°ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì¹´ë©”ë¼ ì˜¤ë²„ë ˆì´ (í† ê¸€) -->
  <div id="camOverlay" class="cam-overlay cam-hidden" aria-hidden="true">
    <video id="camVideo" autoplay muted playsinline></video>
    <canvas id="camCanvas" width="320" height="240"></canvas>
    <div class="note" id="camStatus">ì¹´ë©”ë¼: ë¹„í™œì„±</div>
    <div style="display:flex; gap:8px; justify-content:space-between;">
      <button class="btn ghost" id="camStop">ì¤‘ì§€</button>
      <button class="btn" id="camPause">ì¼ì‹œì •ì§€</button>
    </div>
  </div>

  <!-- ìŒì„± ì¸ì‹ ìƒíƒœ í‘œì‹œ -->
  <div id="voiceStatus" class="voice-status hidden">
    <div id="voiceStatusText">ìŒì„± ì¸ì‹ ì¤‘...</div>
  </div>

  <div class="wrap">
    <div class="anchor-indicator" id="anchorInfo">ANCHOR: middle</div>
    <div class="frame">
      <div class="scale-shell">
        <!-- ì›ë³¸ í‚¤ì˜¤ìŠ¤í¬ ì•± ì‹œì‘ (ìš”ì•½ ë²„ì „) -->
        <div id="appRoot" class="app">
          <header>
            <div class="title">ì ì‘í˜• í‚¤ì˜¤ìŠ¤í¬ (ì›ë³¸ ì¶•ì†Œ í”„ë¦¬ë·°)</div>
            <div class="sp"></div>
            <button class="btn ghost" id="aMinus">Aâˆ’</button>
            <button class="btn ghost" id="aPlus">Aï¼‹</button>
          </header>

          <main class="grid cols-2">
            <section class="card" aria-labelledby="sec-menu">
              <h2 id="sec-menu">ë©”ë‰´ ì„ íƒ</h2>
              <div class="row" id="catTabs"></div>
              <div class="items" id="itemGrid"></div>

              <div class="sticky-btm row">
                <button class="btn ghost" id="btnCancel">ì·¨ì†Œ</button>
                <div class="sp"></div>
                <button class="btn" id="btnNext" disabled>ë‹¤ìŒ</button>
              </div>
            </section>

            <aside class="card" aria-labelledby="sec-cart">
              <h2 id="sec-cart">ì¥ë°”êµ¬ë‹ˆ</h2>
              <div id="cartList" class="grid" style="gap:8px;"></div>
              <hr />
              <div class="row" style="justify-content:space-between;">
                <div class="note">í•©ê³„</div>
                <strong id="cartTotal">â‚©0</strong>
              </div>
              <div class="row" style="justify-content:flex-end; margin-top:8px;">
                <button class="btn ghost" id="btnClear">ë¹„ìš°ê¸°</button>
              </div>
            </aside>

            <dialog id="optModal">
              <div class="card">
                <h3 id="optTitle" style="margin:0 0 10px 0;">ì˜µì…˜ ì„ íƒ</h3>
                <div class="row" id="optSize"></div>
                <div class="row" id="optSweet"></div>
                <div class="row" id="optIce"></div>
                <div class="row" style="justify-content:flex-end; margin-top:10px;">
                  <button class="btn ghost" id="optClose">ì·¨ì†Œ</button>
                  <button class="btn" id="optOk">ë‹´ê¸°</button>
                </div>
              </div>
            </dialog>

            <section class="card" id="sectionConfirm" style="display:none;" aria-labelledby="sec-check">
              <h2 id="sec-check">ì£¼ë¬¸ í™•ì¸</h2>
              <div id="confirmList" class="grid" style="gap:8px;"></div>
              <div class="row" style="justify-content: space-between;">
                <div class="note">í•©ê³„</div>
                <strong id="confirmTotal">â‚©0</strong>
              </div>
              <div class="row" style="justify-content:flex-end; margin-top:8px;">
                <button class="btn ghost" id="btnBackToMenu">ë©”ë‰´ë¡œ</button>
                <button class="btn" id="btnPay">ê²°ì œí•˜ê¸°</button>
              </div>
            </section>

            <section class="card" id="sectionPaid" style="display:none;" aria-labelledby="sec-paid">
              <h2 id="sec-paid">ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
              <p class="note">ì£¼ë¬¸ ë²ˆí˜¸: <span id="orderNo"></span></p>
              <div class="row">
                <button class="btn" id="btnNew">ìƒˆ ì£¼ë¬¸</button>
              </div>
            </section>
          </main>
        </div>
        <!-- ì›ë³¸ ì•± ë -->
      </div>
      <div class="chrome"></div>
    </div>
  </div>

  <script>
    (function () {
      /* -- face-api.js ë¡œë”© (ì„ íƒ) --
         ì´ í”„ë¡œì íŠ¸ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¡œì»¬ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì‹¤ì œ ì—°ë ¹ ì¶”ì •ì„ ì‚¬ìš©í•˜ë ¤ë©´
         1) face-api ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤ (ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ê±°ë‚˜ CDNì„ ì¶”ê°€)
         2) ëª¨ë¸(weights)ë¥¼ í˜¸ìŠ¤íŒ…í•˜ê³  MODEL_URLë¥¼ í•´ë‹¹ ê²½ë¡œë¡œ ì„¤ì •í•˜ì„¸ìš”.
         ëª¨ë¸ íŒŒì¼ì€ face-apiì˜ age/gender ëª¨ë¸ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
      */
      // ì˜ˆ: <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js">  (ë‹«ëŠ” íƒœê·¸ëŠ” ì‹¤ì œ HTMLì— ì¶”ê°€í•˜ì„¸ìš”)

      /* ==== Vertical anchor state & animation ==== */
      const headerH = 56; // px (matches sticky header)
      const st = { anchor: 'middle', auto: true, ySmoothed: null, target: 0, cur: 0, lastSwitch: 0 };
      const $wrap = document.querySelector('.wrap');
      const $frame = document.querySelector('.frame');
      const $info = document.getElementById('anchorInfo');

      function metrics() {
        const vh = window.innerHeight;
        const available = Math.max(0, vh - headerH - 32 /*wrap padding top+bottom approx*/ - $frame.offsetHeight);
        const top = 0;
        const mid = available / 2;
        const bot = available;
        return { top, mid, bot };
      }
      function setAnchor(pos) {
        st.anchor = pos; st.auto = false; updateTarget(); updateIndicator();
      }
      function setAuto(on = true) { st.auto = on; updateIndicator(); }
      function updateIndicator() { $info.textContent = `ANCHOR: ${st.auto ? 'autoâ†’' : ''}${st.anchor}`; }
      function updateTarget() {
        const m = metrics();
        st.target = (st.anchor === 'top') ? m.top : (st.anchor === 'bottom' ? m.bot : m.mid);
      }
      function lerp(a, b, t) { return a + (b - a) * t; }
      function animate() {
        st.cur = lerp(st.cur, st.target, 0.12);
        $frame.style.transform = `translateY(${st.cur}px)`;
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);

      // Auto logic from external faceY (0..1). Call window.uiAnchor.auto(y)
      function decideAnchorFromY(y) {
        const now = performance.now();
        // smooth the signal
        st.ySmoothed = (st.ySmoothed == null) ? y : (st.ySmoothed * 0.85 + y * 0.15);
        const yS = st.ySmoothed;
        // hysteresis thresholds
        const cur = st.anchor;
        let next = cur;
        if (cur === 'top') {
          if (yS > 0.45) next = 'middle';
        } else if (cur === 'middle') {
          if (yS < 0.30) next = 'top';
          else if (yS > 0.70) next = 'bottom';
        } else if (cur === 'bottom') {
          if (yS < 0.55) next = 'middle';
        }
        // require dwell time 800ms before switching
        if (next !== cur && (now - st.lastSwitch) > 800) { st.anchor = next; st.lastSwitch = now; updateTarget(); updateIndicator(); }
      }

      // recompute on resize / scale change
      function recompute() { updateTarget(); }
      window.addEventListener('resize', recompute);

      // expose API
      window.uiAnchor = {
        set(pos) { setAnchor(pos); },
        auto(y) { setAuto(true); if (typeof y === 'number') decideAnchorFromY(Math.min(1, Math.max(0, y))); },
        enableAuto() { setAuto(true); },
        disableAuto() { setAuto(false); },
        get current() { return st.anchor; }
      };

      // header controls
      document.getElementById('anchorTop').onclick = () => setAnchor('top');
      document.getElementById('anchorMid').onclick = () => setAnchor('middle');
      document.getElementById('anchorBot').onclick = () => setAnchor('bottom');
      document.getElementById('anchorAuto').onclick = () => setAuto(true);

      // initial
      updateTarget(); updateIndicator();

      /* === í”„ë¦¬ë·° ìŠ¤ì¼€ì¼ ì¡°ì ˆ === */
      const range = document.getElementById('scale');
      const root = document.documentElement;
      function setScale(v) { root.style.setProperty('--uiScale', String(v)); /* frame size changes â†’ recompute anchor positions */ setTimeout(() => { const ev = new Event('resize'); window.dispatchEvent(ev); }, 0); }
      range.addEventListener('input', e => setScale(e.target.value));
      document.querySelectorAll('button[data-z]').forEach(b => b.addEventListener('click', () => { const v = b.dataset.z; range.value = v; setScale(v); }));

      /* === ì›ë³¸ ì•± ë¡œì§(ê°„ë‹¨í™” ìš”ì•½) === */
      const PRODUCTS = [
        { id: 'a1', cat: 'ì»¤í”¼', name: 'ì•„ë©”ë¦¬ì¹´ë…¸', price: 2500 },
        { id: 'a2', cat: 'ì»¤í”¼', name: 'ì¹´í˜ë¼í…Œ', price: 3200 },
        { id: 'a3', cat: 'ì»¤í”¼', name: 'ë°”ë‹ë¼ë¼í…Œ', price: 3600 },
        { id: 't1', cat: 'í‹°', name: 'ë…¹ì°¨', price: 2800 },
        { id: 't2', cat: 'í‹°', name: 'ì–¼ê·¸ë ˆì´', price: 3000 },
        { id: 'c1', cat: 'ì´ˆì½œë¦¿', name: 'í•«ì´ˆì½”', price: 3000 },
        { id: 's1', cat: 'ìŠ¤ë‚µ', name: 'ì¿ í‚¤', price: 1800 },
        { id: 's2', cat: 'ìŠ¤ë‚µ', name: 'ë¨¸í•€', price: 2200 }
      ];
      const CATS = [...new Set(PRODUCTS.map(p => p.cat))];
      const OPTION_PRESET = {
        size: [['S', 'ì†Œ'], ['M', 'ì¤‘'], ['L', 'ëŒ€']],
        sweet: [['0', 'ë¬´ê°€ë‹¹'], ['50', '50%'], ['100', '100%']],
        ice: [['less', 'ì ê²Œ'], ['normal', 'ë³´í†µ'], ['more', 'ë§ì´']]
      };
      const state = { cart: [], cat: CATS[0] };
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const fmt = v => v.toLocaleString('ko-KR');

      function renderCats() {
        const wrap = $('#catTabs'); wrap.innerHTML = '';
        CATS.forEach(cat => {
          const b = document.createElement('button'); b.className = 'chip' + (state.cat === cat ? ' on' : ''); b.textContent = cat;
          b.addEventListener('click', () => { state.cat = cat; renderCats(); renderItems(); });
          wrap.appendChild(b);
        });
      }
      function renderItems() {
        const grid = $('#itemGrid'); grid.innerHTML = '';
        PRODUCTS.filter(p => p.cat === state.cat).forEach(p => {
          const btn = document.createElement('button'); btn.className = 'item';
          btn.innerHTML = `<div><div style="font-weight:800">${p.name}</div><div class="note">${p.cat}</div></div><div><strong>â‚©${fmt(p.price)}</strong></div>`;
          btn.addEventListener('click', () => openOption(p));
          grid.appendChild(btn);
        });
      }
      function openOption(prod) {
        const m = $('#optModal'); $('#optTitle').textContent = `[${prod.name}] ì˜µì…˜`;
        fill('#optSize', 'size', 'M'); fill('#optSweet', 'sweet', '50'); fill('#optIce', 'ice', 'normal');
        function fill(sel, key, def) {
          const row = $(sel); row.innerHTML = '';
          for (const [val, label] of OPTION_PRESET[key]) { const b = document.createElement('button'); b.className = 'chip'; b.textContent = label; b.dataset.group = key; b.dataset.val = val; if (val === def) b.classList.add('on'); b.addEventListener('click', () => { $$(`button.chip[data-group="${key}"]`).forEach(x => x.classList.remove('on')); b.classList.add('on'); }); row.appendChild(b); }
        }
        $('#optClose').onclick = () => m.close();
        $('#optOk').onclick = () => { const sel = g => $(`button.chip[data-group="${g}"][class*="on"]`)?.dataset.val; addToCart({ id: prod.id, name: prod.name, price: prod.price, size: sel('size'), sweet: sel('sweet'), ice: sel('ice'), qty: 1 }); m.close(); };
        m.showModal();
      }
      function addToCart(item) { const key = `${item.id}-${item.size}-${item.sweet}-${item.ice}`; const f = state.cart.find(it => `${it.id}-${it.size}-${it.sweet}-${it.ice}` === key); if (f) f.qty += 1; else state.cart.push(item); renderCart(); $('#btnNext').disabled = state.cart.length === 0; }
      function renderCart() { const box = $('#cartList'); box.innerHTML = ''; let total = 0; state.cart.forEach((it, idx) => { const sub = it.price * it.qty; total += sub; const line = document.createElement('div'); line.className = 'row'; line.style.justifyContent = 'space-between'; line.innerHTML = `<div><strong>${it.name}</strong> <span class='note'>(${it.size}/${it.sweet}/${it.ice})Ã—${it.qty}</span></div><div><strong>â‚©${fmt(sub)}</strong></div>`; box.appendChild(line); }); $('#cartTotal').textContent = `â‚©${fmt(total)}`; }
      function showConfirm() { const list = $('#confirmList'); list.innerHTML = ''; let total = 0; state.cart.forEach(it => { const sub = it.price * it.qty; total += sub; const row = document.createElement('div'); row.className = 'row'; row.style.justifyContent = 'space-between'; row.innerHTML = `<div>${it.name} <span class='note'>(${it.size}/${it.sweet}/${it.ice}) Ã— ${it.qty}</span></div><div><strong>â‚©${fmt(sub)}</strong></div>`; list.appendChild(row); }); $('#confirmTotal').textContent = `â‚©${fmt(total)}`; document.querySelector('section[aria-labelledby="sec-menu"]').style.display = 'none'; $('#sectionConfirm').style.display = 'block'; }
      function showPaid() { $('#sectionConfirm').style.display = 'none'; $('#sectionPaid').style.display = 'block'; $('#orderNo').textContent = (Date.now() % 1000000).toString().padStart(6, '0'); }

      $('#btnCancel').addEventListener('click', () => { if (confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí• ê¹Œìš”?')) location.reload(); });
      $('#btnClear').addEventListener('click', () => { state.cart = []; renderCart(); $('#btnNext').disabled = true; });
      $('#btnNext').addEventListener('click', showConfirm);
      $('#btnBackToMenu').addEventListener('click', () => { $('#sectionConfirm').style.display = 'none'; document.querySelector('section[aria-labelledby="sec-menu"]').style.display = 'block'; });
      $('#btnPay').addEventListener('click', showPaid);
      $('#btnNew').addEventListener('click', () => location.reload());

      renderCats(); renderItems(); renderCart();

      /* ===== ì—°ë ¹ ê¸°ë°˜ ì ì‘ UI ë¡œì§ ===== */
      const AGE_KEY = 'kioskAgeGroup';
      const YEAR_KEY = 'kioskBirthYear';
      const $ageModal = document.getElementById('ageModal');
      const $birth = document.getElementById('birthYear');
      const $ageApply = document.getElementById('ageApply');
      const $ageSkip = document.getElementById('ageSkip');
      const $changeAgeBtn = document.getElementById('changeAgeBtn');

      function computeAgeGroupFromYear(y) {
        const year = Number(y);
        if (!year || isNaN(year) || year < 1900 || year > (new Date().getFullYear() + 1)) return 'adult';
        const age = new Date().getFullYear() - year;
        if (age <= 12) return 'child';
        if (age <= 17) return 'teen';
        if (age <= 64) return 'adult';
        return 'senior';
      }

      function applyAgeGroup(group) {
        const body = document.body;
        ['age-child', 'age-teen', 'age-adult', 'age-senior'].forEach(c => body.classList.remove(c));
        body.classList.add(`age-${group}`);
        try { localStorage.setItem(AGE_KEY, group); } catch (e) { }
        // highlight chips inside modal if present
        $ageModal.querySelectorAll('button.chip').forEach(b => b.classList.toggle('on', b.dataset.age === group));
      }

      function openAgeModal() { $ageModal.setAttribute('aria-hidden', 'false'); $birth.focus(); }
      function closeAgeModal() { $ageModal.setAttribute('aria-hidden', 'true'); }

      // wire chips
      $ageModal.querySelectorAll('button.chip').forEach(b => b.addEventListener('click', () => { const g = b.dataset.age; applyAgeGroup(g); try { localStorage.setItem(AGE_KEY, g); localStorage.removeItem(YEAR_KEY); } catch (e) { }; closeAgeModal(); }));

      // apply from birth year
      $ageApply.addEventListener('click', () => {
        const v = $birth.value.trim();
        const g = computeAgeGroupFromYear(v);
        applyAgeGroup(g);
        try { localStorage.setItem(AGE_KEY, g); if (v) localStorage.setItem(YEAR_KEY, v); } catch (e) { }
        closeAgeModal();
      });

      $ageSkip.addEventListener('click', () => { applyAgeGroup('adult'); closeAgeModal(); });
      $changeAgeBtn && $changeAgeBtn.addEventListener('click', () => { openAgeModal(); });

      // restore saved group/year or prompt
      (function restoreAge() {
        try {
          const saved = localStorage.getItem(AGE_KEY);
          const byear = localStorage.getItem(YEAR_KEY);
          if (saved) { applyAgeGroup(saved); }
          else if (byear) { applyAgeGroup(computeAgeGroupFromYear(byear)); }
          else { openAgeModal(); }
        } catch (e) { openAgeModal(); }
      })();

      /* ===== ì¹´ë©”ë¼ ê¸°ë°˜ ìë™ ì—°ë ¹ ì¶”ì  (ë¡œì»¬, ê°œì¸ì •ë³´ ì£¼ì˜) ===== */
      const AUTO_AGE_KEY = 'kioskAutoAgeEnabled';
      const MODEL_URLS = [
        './models',
        'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights'
      ];
      const $autoBtn = document.getElementById('autoAgeCamBtn');
      const $camOverlay = document.getElementById('camOverlay');
      const $camVideo = document.getElementById('camVideo');
      const $camCanvas = document.getElementById('camCanvas');
      const $camStatus = document.getElementById('camStatus');
      const $camStop = document.getElementById('camStop');
      const $camPause = document.getElementById('camPause');
      let camStream = null; let camPaused = false; let detectorEnabled = false; let faceapiAvailable = (window.faceapi !== undefined);
      let modelLoaded = false; let modelBase = null;

      function setCamStatus(text) { $camStatus.textContent = 'ì¹´ë©”ë¼: ' + text; }

      async function tryLoadModels() {
        if (!window.faceapi) return false;
        for (const base of MODEL_URLS) {
          try {
            await Promise.all([
              faceapi.nets.tinyFaceDetector.loadFromUri(base),
              faceapi.nets.ageGenderNet.loadFromUri(base)
            ]);
            modelLoaded = true; modelBase = base; console.info('face-api models loaded from', base); return true;
          } catch (e) { console.warn('model load failed from', base, e); }
        }
        return false;
      }

      async function startCamera() {
        if (camStream) return;
        try {
          camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
          $camVideo.srcObject = camStream; $camOverlay.classList.remove('cam-hidden'); $camOverlay.setAttribute('aria-hidden', 'false'); setCamStatus('ì‹¤í–‰ ì¤‘');
          // try to load face-api models if available
          if (faceapiAvailable && !modelLoaded) { await tryLoadModels(); }
          detectorEnabled = true; runDetectionLoop();
        } catch (err) { console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨', err); setCamStatus('ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ì˜¤ë¥˜'); detectorEnabled = false; }
      }

      function stopCamera() { if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; } $camOverlay.classList.add('cam-hidden'); $camOverlay.setAttribute('aria-hidden', 'true'); setCamStatus('ë¹„í™œì„±'); detectorEnabled = false; }

      $autoBtn && $autoBtn.addEventListener('click', async () => { const enabled = localStorage.getItem(AUTO_AGE_KEY) === '1'; if (enabled) { localStorage.removeItem(AUTO_AGE_KEY); stopCamera(); $autoBtn.classList.remove('primary'); } else { localStorage.setItem(AUTO_AGE_KEY, '1'); $autoBtn.classList.add('primary'); await startCamera(); } });

      $camStop.addEventListener('click', () => { localStorage.removeItem(AUTO_AGE_KEY); stopCamera(); $autoBtn.classList.remove('primary'); });
      $camPause.addEventListener('click', () => { camPaused = !camPaused; $camPause.textContent = camPaused ? 'ì¬ì‹œì‘' : 'ì¼ì‹œì •ì§€'; setCamStatus(camPaused ? 'ì¼ì‹œì •ì§€' : 'ì‹¤í–‰ ì¤‘'); });

      // detection loop: uses faceapi if available+models loaded, otherwise no-op
      async function runDetectionLoop() {
        const ctx = $camCanvas.getContext('2d');
        while (detectorEnabled && camStream) {
          if (camPaused) { await new Promise(r => setTimeout(r, 300)); continue; }
          if ($camVideo.readyState >= 2) {
            $camCanvas.width = $camVideo.videoWidth; $camCanvas.height = $camVideo.videoHeight; ctx.drawImage($camVideo, 0, 0, $camCanvas.width, $camCanvas.height);
            if (faceapiAvailable && modelLoaded) {
              try {
                const detections = await faceapi.detectSingleFace($camVideo, new faceapi.TinyFaceDetectorOptions()).withAgeAndGender();
                if (detections && detections.age) {
                  const estAge = Math.round(detections.age);
                  setCamStatus('ì¶”ì • ì—°ë ¹: ' + estAge + 'ì„¸');
                  const group = computeAgeGroupFromYear(new Date().getFullYear() - estAge);
                  applyAgeGroup(group);
                } else { setCamStatus('ì–¼êµ´ ë¯¸ê²€ì¶œ'); }
              } catch (e) { console.warn('faceapi detect failed', e); setCamStatus('ì¶”ì • ì˜¤ë¥˜'); }
            } else {
              // ëª¨ë¸ì´ ì—†ìœ¼ë©´ ì•ˆë‚´
              setCamStatus('ëª¨ë¸ ë¯¸ì„¤ì¹˜: ì‹¤ì¸¡ ì¶”ì • ë¶ˆê°€(ì„¤ì¹˜ í•„ìš”)');
            }
          }
          await new Promise(r => setTimeout(r, 900));
        }
      }

      // restore auto camera state
      (function restoreAutoCam() { try { if (localStorage.getItem(AUTO_AGE_KEY) === '1') { $autoBtn && $autoBtn.classList.add('primary'); startCamera(); } } catch (e) { } })();
    })();

          /* ===== ìŒì„± ì¸ì‹ ê¸°ëŠ¥ ===== */
      // ì›¹í›… URL ì„¤ì • (n8n ë“±)
      const WEBHOOK_URL = 'https://n8n.taetae.dev/webhook-test/fc5a5594-ef80-4776-8b0d-fbbfee42227a'; // ì—¬ê¸°ì— n8n ì›¹í›… URLì„ ì…ë ¥í•˜ì„¸ìš”

      const $voiceBtn = document.getElementById('voiceBtn');
      const $voiceStatus = document.getElementById('voiceStatus');
      const $voiceStatusText = document.getElementById('voiceStatusText');

      // Web Speech API ì§€ì› í™•ì¸
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognition = null;
      let isRecording = false;

      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •
        recognition.continuous = false; // í•œ ë²ˆì˜ ì¸ì‹ í›„ ì¢…ë£Œ
        recognition.interimResults = true; // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ

        // ìŒì„± ì¸ì‹ ì‹œì‘ ì´ë²¤íŠ¸
        recognition.onstart = function() {
          console.log('ìŒì„± ì¸ì‹ ì‹œì‘');
          isRecording = true;
          $voiceBtn.classList.add('recording');
          $voiceStatus.classList.remove('hidden');
          $voiceStatusText.textContent = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ë§ì”€í•˜ì„¸ìš”';
        };

        // ìŒì„± ì¸ì‹ ê²°ê³¼ ì´ë²¤íŠ¸
        recognition.onresult = function(event) {
          let interimTranscript = '';
          let finalTranscript = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }

          // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
          if (interimTranscript) {
            $voiceStatusText.textContent = `ğŸ¤ "${interimTranscript}"`;
          }

          // ìµœì¢… ê²°ê³¼ ì²˜ë¦¬
          if (finalTranscript) {
            console.log('ì¸ì‹ëœ í…ìŠ¤íŠ¸:', finalTranscript);
            $voiceStatusText.textContent = `âœ“ ì¸ì‹ ì™„ë£Œ: "${finalTranscript}"`;
            
            // ì›¹í›…ìœ¼ë¡œ ì „ì†¡
            sendToWebhook(finalTranscript);
          }
        };

        // ìŒì„± ì¸ì‹ ì¢…ë£Œ ì´ë²¤íŠ¸
        recognition.onend = function() {
          console.log('ìŒì„± ì¸ì‹ ì¢…ë£Œ');
          isRecording = false;
          $voiceBtn.classList.remove('recording');
          
          // 3ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
          setTimeout(() => {
            $voiceStatus.classList.add('hidden');
          }, 3000);
        };

        // ì˜¤ë¥˜ ì²˜ë¦¬
        recognition.onerror = function(event) {
          console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
          isRecording = false;
          $voiceBtn.classList.remove('recording');
          
          let errorMessage = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
          switch(event.error) {
            case 'no-speech':
              errorMessage = 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
              break;
            case 'audio-capture':
              errorMessage = 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
              break;
            case 'not-allowed':
              errorMessage = 'ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
              break;
            case 'network':
              errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
              break;
          }
          
          $voiceStatusText.textContent = `âŒ ${errorMessage}`;
          setTimeout(() => {
            $voiceStatus.classList.add('hidden');
          }, 3000);
        };
      }

      // ì›¹í›…ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
      async function sendToWebhook(text) {
        if (!WEBHOOK_URL) {
          console.warn('ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
          $voiceStatusText.textContent = 'âš ï¸ ì›¹í›… URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”';
          return;
        }

        try {
          const payload = {
            text: text,
            timestamp: new Date().toISOString(),
            language: 'ko-KR'
          };

          console.log('ì›¹í›…ìœ¼ë¡œ ì „ì†¡:', payload);
          
          const response = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            console.log('ì›¹í›… ì „ì†¡ ì„±ê³µ');
            $voiceStatusText.textContent = `âœ“ ì „ì†¡ ì™„ë£Œ: "${text}"`;
          } else {
            console.error('ì›¹í›… ì „ì†¡ ì‹¤íŒ¨:', response.status);
            $voiceStatusText.textContent = `âŒ ì „ì†¡ ì‹¤íŒ¨ (${response.status})`;
          }
        } catch (error) {
          console.error('ì›¹í›… ì „ì†¡ ì˜¤ë¥˜:', error);
          $voiceStatusText.textContent = `âŒ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`;
        }
      }

      // ìŒì„± ì¸ì‹ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      if ($voiceBtn) {
        $voiceBtn.addEventListener('click', function() {
          if (!SpeechRecognition) {
            alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nChrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
            return;
          }

          if (isRecording) {
            // ë…¹ìŒ ì¤‘ì´ë©´ ì¤‘ì§€
            recognition.stop();
          } else {
            // ë…¹ìŒ ì‹œì‘
            try {
              recognition.start();
            } catch (error) {
              console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì˜¤ë¥˜:', error);
              if (error.name === 'InvalidStateError') {
                // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš° ë¬´ì‹œ
                console.log('ìŒì„± ì¸ì‹ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤');
              }
            }
          }
        });
      }
  </script>
</body>

</html>