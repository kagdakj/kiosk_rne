<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>적응형 키오스크 웹앱 (Vertical Anchor)</title>
  <style>
    :root{
      --fontScale: 1.00;
      --buttonScale: 1.00;
      --radius: 16px;
      --gap: 12px;
      --headerH: 56px;

      /* 라이트 테마 */
      --bg: #ffffff; --fg: #111111; --muted:#6b7280; --panel:#f3f4f6; --border:#e5e7eb;
      --accent:#2563eb; --accent-contrast:#ffffff; --danger:#dc2626; --ok:#16a34a;
    }
    .theme-hc{ /* 고대비 테마 */
      --bg:#000000; --fg:#ffffff; --muted:#cbd5e1; --panel:#0f0f10; --border:#2a2a2a;
      --accent:#ffcc00; --accent-contrast:#000000; --danger:#ff4444; --ok:#22c55e;
    }

    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      font-size: calc(16px * var(--fontScale)); line-height:1.35; -webkit-tap-highlight-color: transparent;
    }

    header{ position:sticky; top:0; z-index:50; background:var(--bg); border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:12px; padding:10px 14px; height: var(--headerH); box-sizing: border-box; }
    header h1{ font-size:1.1rem; margin:0; }
    .sp{ flex:1; }

    /* ====== Viewport vertical anchor system ====== */
    .viewport{ min-height: calc(100vh - var(--headerH)); display:flex; padding: 6px 0; }
    .anchor-top   .viewport{ justify-content: flex-start; }
    .anchor-middle .viewport{ justify-content: center; }
    .anchor-bottom .viewport{ justify-content: flex-end; }
    .anchor-bottom main{ margin-bottom: 12px; }

    .btn{ cursor:pointer; user-select:none; display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:none; border-radius:var(--radius); font-weight:800; background:var(--accent); color:var(--accent-contrast);
      padding: 12px 18px; min-height: calc(48px * var(--buttonScale)); min-width: calc(48px * var(--buttonScale));
      transition: transform .05s ease; font-size:1rem; }
    .btn:active{ transform: scale(0.98); }
    .btn.secondary{ background:var(--panel); color:var(--fg); border:1px solid var(--border); }
    .btn.ghost{ background:transparent; color:var(--fg); border:1px solid var(--border); }
    .btn.ok{ background:var(--ok); color:#fff; } .btn.danger{ background:var(--danger); color:#fff; }

    main{ max-width:1100px; margin:0 auto; padding:14px; }
    .grid{ display:grid; gap:var(--gap); }
    .cols-2{ grid-template-columns: 1.2fr .8fr; }
    .cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 960px){ .cols-2, .cols-3 { grid-template-columns: 1fr; } }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; }
    .muted{ color:var(--muted); font-size:.95rem; }

    .toolbar .btn{ min-width:auto; padding:10px 12px; }

    .categories{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ border:1px solid var(--border); background:var(--bg); color:var(--fg); padding:8px 12px; border-radius:999px;
      font-weight:700; cursor:pointer; }
    .chip.on{ background:var(--accent); color:var(--accent-contrast); border-color:transparent; }

    .items{ display:grid; gap:var(--gap); grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width: 720px){ .items{ grid-template-columns: 1fr; } }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:#fff; color:#111;
      border:1px solid var(--border); border-radius:var(--radius); padding:14px; min-height: calc(72px * var(--buttonScale)); }
    body.theme-hc .item{ background:#000; color:#fff; border-color:#2a2a2a; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .sp-right{ margin-left:auto; }

    .sticky-btm{ position:sticky; bottom:0; background:var(--bg); border-top:1px solid var(--border);
      padding-top:10px; padding-bottom:10px; }

    .wizard{ display:flex; gap:8px; margin:4px 0 10px; }
    .dot{ width:12px; height:12px; border-radius:999px; background:var(--border); }
    .dot.on{ background:var(--accent); }

    .kbd{ font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace; background:var(--panel);
      border:1px solid var(--border); border-bottom-width:2px; border-radius:8px; padding:2px 6px; }

    dialog{ border:none; border-radius:16px; padding:0; width:min(520px, 92vw); }
    dialog::backdrop{ background: rgba(0,0,0,.45); }
    .modal{ background:var(--bg); color:var(--fg); border:1px solid var(--border); border-radius:16px; padding:14px; }

    .cart-row{ display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; }
    .cart-row .qty{ display:inline-flex; align-items:center; gap:6px; }

    #monitor{ position:fixed; right:12px; bottom:12px; width:min(380px, 92vw); max-height:62vh; overflow:auto; z-index:60;
      background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px; font-size:.92rem; }
    #monitor h3{ margin:0 0 8px 0; font-size:1rem; }
    #monitor pre{ margin:0; white-space:pre-wrap; }

    :focus-visible{ outline: 3px solid var(--accent); outline-offset: 2px; }
  </style>
</head>
<body class="anchor-middle">
  <header>
    <h1>적응형 키오스크</h1>
    <div class="sp"></div>
    <div class="toolbar row" role="toolbar" aria-label="접근성 & 앵커">
      <button class="btn ghost" id="aMinus" title="글자 축소">A−</button>
      <button class="btn ghost" id="aPlus" title="글자 확대">A＋</button>
      <button class="btn ghost" id="toggleHC" title="고대비 전환">고대비</button>
      <button class="btn ghost" id="anchorUp" title="화면을 위로 정렬">위로</button>
      <button class="btn ghost" id="anchorMid" title="화면을 가운데 정렬">가운데</button>
      <button class="btn ghost" id="anchorDown" title="화면을 아래로 정렬">아래로</button>
      <button class="btn ghost" id="anchorAuto" title="자동 정렬(외부 신호)">자동</button>
      <button class="btn ghost" id="reset" title="초기화">리셋</button>
    </div>
  </header>

  <div class="viewport">
    <main class="grid cols-2">
      <section class="card" aria-labelledby="sec-menu">
        <div class="wizard" aria-hidden="true">
          <div class="dot on"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <h2 id="sec-menu">메뉴 선택</h2>
        <div class="categories" id="catTabs" role="tablist" aria-label="카테고리"></div>
        <div class="items" id="itemGrid" role="list"></div>

        <div class="sticky-btm row">
          <button class="btn ghost" id="btnCancel">취소</button>
          <div class="sp"></div>
          <button class="btn" id="btnNext" disabled>다음</button>
        </div>
      </section>

      <aside class="card" aria-labelledby="sec-cart">
        <h2 id="sec-cart">장바구니</h2>
        <div id="cartList" class="grid" style="gap:8px;"></div>
        <hr style="opacity:.3" />
        <div class="row" style="justify-content: space-between;">
          <div class="muted">합계</div>
          <strong id="cartTotal">₩0</strong>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:8px;">
          <button class="btn secondary" id="btnClear">비우기</button>
        </div>

        <hr style="opacity:.3; margin:12px 0;" />
        <h3 style="margin:0 0 6px 0;">개인화 프리셋</h3>
        <div class="row">
          <button class="chip" data-preset="default">기본</button>
          <button class="chip" data-preset="senior">고령 우선</button>
          <button class="chip" data-preset="vision">가독성↑</button>
          <button class="chip" data-preset="compact">콤팩트</button>
        </div>
        <p class="muted" style="margin-top:8px;">외부 추정기(<span class="kbd">ageEstimator</span>) 또는 <span class="kbd">uiAnchor.auto(y)</span> 신호와 연동 가능.</p>
      </aside>

      <dialog id="optModal">
        <div class="modal">
          <h3 id="optTitle" style="margin:10px 10px 0 10px;">옵션 선택</h3>
          <div class="grid" style="padding:10px; gap:10px;">
            <div class="card">
              <div class="muted">사이즈</div>
              <div class="row" id="optSize"></div>
            </div>
            <div class="card">
              <div class="muted">당도</div>
              <div class="row" id="optSweet"></div>
            </div>
            <div class="card">
              <div class="muted">얼음</div>
              <div class="row" id="optIce"></div>
            </div>
          </div>
          <div class="row" style="justify-content:flex-end; padding:10px;">
            <button class="btn ghost" id="optClose">취소</button>
            <button class="btn ok" id="optOk">담기</button>
          </div>
        </div>
      </dialog>

      <section class="card" id="sectionConfirm" style="display:none;" aria-labelledby="sec-check">
        <div class="wizard" aria-hidden="true">
          <div class="dot"></div><div class="dot on"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <h2 id="sec-check">주문 확인</h2>
        <div id="confirmList" class="grid" style="gap:8px;"></div>
        <div class="row" style="justify-content: space-between;">
          <div class="muted">합계</div>
          <strong id="confirmTotal">₩0</strong>
        </div>
        <div class="sticky-btm row">
          <button class="btn ghost" id="btnBackToMenu">메뉴로</button>
          <div class="sp"></div>
          <button class="btn ok" id="btnPay">결제하기</button>
        </div>
      </section>

      <section class="card" id="sectionPaid" style="display:none;" aria-labelledby="sec-paid">
        <div class="wizard" aria-hidden="true">
          <div class="dot"></div><div class="dot"></div><div class="dot on"></div><div class="dot"></div>
        </div>
        <h2 id="sec-paid">결제가 완료되었습니다</h2>
        <p class="muted">주문 번호: <span id="orderNo"></span></p>
        <div class="row">
          <button class="btn" id="btnNew">새 주문</button>
          <button class="btn ghost" id="btnExport">CSV 내보내기</button>
        </div>
      </section>
    </main>
  </div>

  <aside id="monitor" aria-live="polite">
    <h3>상태 모니터</h3>
    <div class="row" style="margin-bottom:6px;">
      <span class="chip" id="chipTheme">THEME</span>
      <span class="chip" id="chipScale">SCALE</span>
      <span class="chip" id="chipAnchor">ANCHOR</span>
    </div>
    <pre id="mon"></pre>
  </aside>

<script>
(function(){
  /* ===================== 데이터 ===================== */
  const PRODUCTS = [
    { id:'a1', cat:'커피',   name:'아메리카노', price:2500 },
    { id:'a2', cat:'커피',   name:'카페라테',   price:3200 },
    { id:'a3', cat:'커피',   name:'바닐라라테', price:3600 },
    { id:'t1', cat:'티',     name:'녹차',       price:2800 },
    { id:'t2', cat:'티',     name:'얼그레이',   price:3000 },
    { id:'c1', cat:'초콜릿', name:'핫초코',     price:3000 },
    { id:'s1', cat:'스낵',   name:'쿠키',       price:1800 },
    { id:'s2', cat:'스낵',   name:'머핀',       price:2200 },
  ];
  const CATS = [...new Set(PRODUCTS.map(p=>p.cat))];

  const OPTION_PRESET = {
    size: [ ['S','소'], ['M','중'], ['L','대'] ],
    sweet: [ ['0','무가당'], ['50','50%'], ['100','100%'] ],
    ice: [ ['less','적게'], ['normal','보통'], ['more','많이'] ]
  };

  /* ===================== 상태 ===================== */
  const state = {
    ui: { font:1.0, btn: 1.0, hc:false, anchor:'middle' },
    cart: [],
    cat: CATS[0],
    logs: JSON.parse(localStorage.getItem('kiosk_logs')||'[]'),
  };

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt = v => v.toLocaleString('ko-KR');

  function setScale(font, btn){
    state.ui.font = font; state.ui.btn = btn;
    document.documentElement.style.setProperty('--fontScale', String(font));
    document.documentElement.style.setProperty('--buttonScale', String(btn));
    $('#chipScale').textContent = `FONT ${font.toFixed(2)} / BTN ${btn.toFixed(2)}`;
  }
  function setTheme(hc){
    state.ui.hc = !!hc;
    document.body.classList.toggle('theme-hc', state.ui.hc);
    $('#chipTheme').textContent = state.ui.hc ? '고대비 ON' : '고대비 OFF';
  }
  function applyAnchor(pos){
    const map = { top:'anchor-top', middle:'anchor-middle', bottom:'anchor-bottom' };
    state.ui.anchor = (pos in map) ? pos : 'middle';
    document.body.classList.remove('anchor-top','anchor-middle','anchor-bottom');
    document.body.classList.add(map[state.ui.anchor]);
    $('#chipAnchor').textContent = state.ui.anchor.toUpperCase();
    saveUi(); renderMonitor();
  }

  /* ===================== 렌더링 ===================== */
  function renderCats(){
    const wrap = $('#catTabs'); wrap.innerHTML='';
    CATS.forEach(cat=>{
      const b = document.createElement('button');
      b.className = 'chip' + (state.cat===cat ? ' on' : '');
      b.setAttribute('role','tab'); b.setAttribute('aria-selected', state.cat===cat ? 'true':'false');
      b.textContent = cat; b.addEventListener('click', ()=>{ state.cat=cat; renderCats(); renderItems(); });
      wrap.appendChild(b);
    });
  }

  function renderItems(){
    const grid = $('#itemGrid'); grid.innerHTML='';
    const items = PRODUCTS.filter(p=>p.cat===state.cat);
    for(const p of items){
      const btn = document.createElement('button'); btn.className='item'; btn.role='listitem';
      btn.innerHTML = `<div><div style="font-weight:800">${p.name}</div><div class="muted">${p.cat}</div></div><div><strong>₩${fmt(p.price)}</strong></div>`;
      btn.addEventListener('click', ()=> openOption(p));
      grid.appendChild(btn);
    }
  }

  function openOption(prod){
    const m = $('#optModal');
    $('#optTitle').textContent = `[${prod.name}] 옵션`;
    fillOption('#optSize', 'size', 'M');
    fillOption('#optSweet', 'sweet', '50');
    fillOption('#optIce', 'ice', 'normal');

    function fillOption(sel, key, def){
      const row = $(sel); row.innerHTML='';
      for(const [val, label] of OPTION_PRESET[key]){
        const b = document.createElement('button'); b.className='chip';
        b.dataset.group = key; b.dataset.val = val; b.textContent = label;
        if(val===def) b.classList.add('on');
        b.addEventListener('click', ()=>{
          $$(`button.chip[data-group="${key}"]`).forEach(x=>x.classList.remove('on'));
          b.classList.add('on');
        });
        row.appendChild(b);
      }
    }

    $('#optClose').onclick = ()=> m.close();
    $('#optOk').onclick = ()=>{
      const getSel = g => $(`button.chip[data-group="${g}"][class*="on"]`)?.dataset.val;
      const item = {
        id: prod.id, name: prod.name, price: prod.price,
        size: getSel('size'), sweet: getSel('sweet'), ice: getSel('ice'), qty:1
      };
      addToCart(item);
      m.close();
    };
    m.showModal();
  }

  function addToCart(item){
    const key = `${item.id}-${item.size}-${item.sweet}-${item.ice}`;
    const found = state.cart.find(it=>`${it.id}-${it.size}-${it.sweet}-${it.ice}`===key);
    if(found) found.qty += 1; else state.cart.push(item);
    renderCart();
    $('#btnNext').disabled = state.cart.length===0;
  }

  function renderCart(){
    const box = $('#cartList'); box.innerHTML='';
    let total = 0;
    state.cart.forEach((it, idx)=>{
      const line = document.createElement('div'); line.className='cart-row';
      const sub = it.price * it.qty; total += sub;
      line.innerHTML = `
        <div><strong>${it.name}</strong> <span class="muted">(${it.size}, ${it.sweet}, ${it.ice})</span></div>
        <div class="qty">
          <button class="btn ghost" aria-label="수량 감소">−</button>
          <span>${it.qty}</span>
          <button class="btn ghost" aria-label="수량 증가">＋</button>
        </div>
        <div><strong>₩${fmt(sub)}</strong></div>`;
      const [minus, plus] = line.querySelectorAll('button');
      minus.addEventListener('click', ()=>{ it.qty=Math.max(0,it.qty-1); if(it.qty===0) state.cart.splice(idx,1); renderCart(); $('#btnNext').disabled = state.cart.length===0; });
      plus.addEventListener('click', ()=>{ it.qty+=1; renderCart(); });
      box.appendChild(line);
    });
    $('#cartTotal').textContent = `₩${fmt(total)}`;
  }

  function showConfirm(){
    const list = $('#confirmList'); list.innerHTML='';
    let total=0; state.cart.forEach(it=>{
      const sub = it.price*it.qty; total+=sub;
      const row = document.createElement('div'); row.className='cart-row';
      row.innerHTML = `<div>${it.name} <span class="muted">(${it.size}/${it.sweet}/${it.ice}) × ${it.qty}</span></div><div></div><div><strong>₩${fmt(sub)}</strong></div>`;
      list.appendChild(row);
    });
    $('#confirmTotal').textContent = `₩${fmt(total)}`;

    document.querySelector('section[aria-labelledby="sec-menu"]').style.display = 'none';
    $('#sectionConfirm').style.display = 'block';
  }

  function showPaid(){
    $('#sectionConfirm').style.display = 'none';
    $('#sectionPaid').style.display = 'block';
    $('#orderNo').textContent = (Date.now()%1000000).toString().padStart(6,'0');
  }

  /* ===================== 상호작용 ===================== */
  $('#btnCancel').addEventListener('click', ()=>{ if(confirm('주문을 취소할까요?')) resetAll(); });
  $('#btnClear').addEventListener('click', ()=>{ state.cart=[]; renderCart(); $('#btnNext').disabled=true; });
  $('#btnNext').addEventListener('click', showConfirm);
  $('#btnBackToMenu').addEventListener('click', ()=>{
    $('#sectionConfirm').style.display='none';
    document.querySelector('section[aria-labelledby="sec-menu"]').style.display='block';
  });
  $('#btnPay').addEventListener('click', ()=>{
    const rec = { ts:new Date().toISOString(), order: structuredClone(state.cart), total: totalPrice() };
    state.logs.push(rec); localStorage.setItem('kiosk_logs', JSON.stringify(state.logs));
    showPaid();
  });
  $('#btnNew').addEventListener('click', resetAll);
  $('#btnExport').addEventListener('click', exportCSV);

  function totalPrice(){ return state.cart.reduce((s,it)=>s+it.price*it.qty,0); }
  function exportCSV(){
    const rows = state.logs; if(!rows.length){ alert('내보낼 로그가 없습니다.'); return; }
    const lines = ['ts,total,items'];
    rows.forEach(r=>{
      const items = r.order.map(it=>`${it.name}(${it.size}/${it.sweet}/${it.ice})x${it.qty}`).join('|');
      lines.push(`${r.ts},${r.total},"${items}"`);
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href=url; a.download='kiosk_logs.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  /* ===================== 프리셋 & 외부 연동 ===================== */
  const PRESETS = {
    default: { font:1.00, btn:1.00, hc:false, anchor:'middle' },
    senior:  { font:1.40, btn:1.40, hc:true , anchor:'bottom' },
    vision:  { font:1.30, btn:1.20, hc:true , anchor:'middle' },
    compact: { font:0.95, btn:0.95, hc:false, anchor:'top'    },
  };
  function applyPreset(p){ setScale(p.font, p.btn); setTheme(p.hc); applyAnchor(p.anchor||'middle'); saveUi(); renderMonitor(); }

  $$('aside .chip[data-preset]').forEach(b=>{ b.addEventListener('click', ()=>{ applyPreset(PRESETS[b.dataset.preset]); }); });

  if(window.ageEstimator && typeof window.ageEstimator === 'object'){
    window.ageEstimator.onUpdate = ({ bucket, conf })=>{
      if(conf < 0.6) return;
      if(bucket === '65+') applyPreset(PRESETS.senior);
      else if(bucket === '40–64') applyPreset(PRESETS.vision);
      else applyPreset(PRESETS.default);
    };
  }

  // 외부 카메라 추정 Y (0..1, 위->0, 아래->1)를 전달해 자동 앵커
  window.uiAnchor = {
    set: applyAnchor,
    auto(y){ window.cameraFaceY = y; // 저장
      if(y == null) return applyAnchor('middle');
      if(y > 0.66) applyAnchor('bottom');
      else if(y < 0.33) applyAnchor('top');
      else applyAnchor('middle');
    },
    get current(){ return state.ui.anchor; }
  };

  /* ===================== 접근성 퀵컨트롤 ===================== */
  $('#aMinus').addEventListener('click', ()=>{ setScale(Math.max(0.9, state.ui.font*0.92), Math.max(0.9, state.ui.btn*0.95)); saveUi(); });
  $('#aPlus').addEventListener('click', ()=>{ setScale(Math.min(2.2, state.ui.font*1.08), Math.min(2.2, state.ui.btn*1.08)); saveUi(); });
  $('#toggleHC').addEventListener('click', ()=>{ setTheme(!state.ui.hc); saveUi(); });
  $('#anchorUp').addEventListener('click', ()=> applyAnchor('top'));
  $('#anchorMid').addEventListener('click', ()=> applyAnchor('middle'));
  $('#anchorDown').addEventListener('click', ()=> applyAnchor('bottom'));
  $('#anchorAuto').addEventListener('click', ()=>{
    const y = window.cameraFaceY; // 0..1
    if(y == null) return applyAnchor('middle');
    if(y > 0.66) applyAnchor('bottom'); else if(y < 0.33) applyAnchor('top'); else applyAnchor('middle');
  });
  $('#reset').addEventListener('click', ()=>{ localStorage.removeItem('kiosk_ui'); localStorage.removeItem('kiosk_logs'); location.reload(); });

  function saveUi(){ localStorage.setItem('kiosk_ui', JSON.stringify(state.ui)); }

  /* ===================== 모니터 ===================== */
  function renderMonitor(){ $('#mon').textContent = JSON.stringify({ ui: state.ui, cart: state.cart, cat: state.cat }, null, 2); }

  /* ===================== 초기화 ===================== */
  function resetAll(){
    state.cart = []; renderCart();
    $('#btnNext').disabled = true;
    $('#sectionPaid').style.display='none';
    $('#sectionConfirm').style.display='none';
    document.querySelector('section[aria-labelledby="sec-menu"]').style.display='block';
  }

  try{
    const saved = JSON.parse(localStorage.getItem('kiosk_ui')||'null');
    if(saved){ setScale(saved.font||1, saved.btn||1); setTheme(!!saved.hc); applyAnchor(saved.anchor||'middle'); }
    else { setScale(1,1); setTheme(false); applyAnchor('middle'); }
  }catch(e){ setScale(1,1); setTheme(false); applyAnchor('middle'); }

  renderCats(); renderItems(); renderCart(); renderMonitor();
})();
</script>
</body>
</html>
