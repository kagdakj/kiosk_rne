<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CNN 나이 추정 데모 (TF.js + FaceAPI)</title>
<style>
  :root { --brand:#2563eb; --ok:#16a34a; --warn:#d97706; --bg:#0b0b0c; --fg:#f5f5f7; --panel:#151517; --muted:#9aa0a6; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif; background:var(--bg); color:var(--fg); }
  header { position:sticky; top:0; z-index:10; display:flex; gap:12px; align-items:center; padding:10px 14px; background:var(--panel); border-bottom:1px solid #222; }
  header h1 { font-size:1.05rem; margin:0; }
  main { max-width:1000px; margin:0 auto; padding:14px; display:grid; gap:12px; }
  .grid { display:grid; gap:12px; grid-template-columns: 1.1fr .9fr; } @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
  .card { background:var(--panel); border:1px solid #222; border-radius:12px; padding:12px; }
  .btn { cursor:pointer; user-select:none; border:1px solid #333; background:var(--brand); color:#fff; border-radius:10px; padding:12px 16px; font-weight:700; }
  .btn.ghost { background:transparent; color:var(--fg); }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .muted { color:var(--muted); font-size:.92rem; }
  video, canvas { width:100%; border-radius:12px; background:#000; }
  .stat { display:grid; grid-template-columns: 120px 1fr; gap:6px; }
  .badge { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#111; border:1px solid #333; }
  .ok { color:#10b981; } .warn { color:#fbbf24; }
  #ageVal { font-size:2.0rem; font-weight:800; }
  #overlay { position:absolute; inset:0; pointer-events:none; }
  #stage { position:relative; }
  .kbd { font-family:ui-monospace,Menlo,Consolas,monospace; background:#111; border:1px solid #333; border-bottom-width:2px; border-radius:6px; padding:2px 6px; }
</style>
</head>
<body>
<header>
  <h1>CNN 나이 추정 (웹캠 온디바이스)</h1>
  <div class="row" style="margin-left:auto;">
    <button class="btn" id="btnStart">동의하고 시작</button>
    <button class="btn ghost" id="btnStop" disabled>중지</button>
  </div>
</header>

<main class="grid">
  <div class="card">
    <div id="stage">
      <video id="video" playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="row" style="justify-content:space-between; margin-top:8px;">
      <div class="badge"><strong>모델:</strong> <span id="modelInfo" class="muted">로딩 전</span></div>
      <div class="badge"><strong>백엔드:</strong> <span id="backendInfo" class="muted">-</span></div>
      <div class="badge"><strong>FPS:</strong> <span id="fpsInfo" class="muted">-</span></div>
    </div>
    <p class="muted">※ HTTPS 환경과 카메라 권한이 필요합니다(모바일 Safari의 경우 무음/playsinline 설정 필수). 모델과 추론은 브라우저에서만 실행됩니다.</p>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">실시간 추정값</h3>
    <div class="stat"><div>안정화 나이</div><div id="ageVal">—</div></div>
    <div class="stat"><div>추정 성별</div><div id="genderVal">—</div></div>
    <div class="stat"><div>연령대 버킷</div><div id="bucketVal">—</div></div>
    <div class="stat"><div>신뢰도(EMA)</div><div id="confVal">—</div></div>

    <hr style="border-color:#222" />
    <h4 style="margin:.4rem 0;">키오스크 연동 예시</h4>
    <ul class="muted" style="margin:.2rem 0 .6rem;">
      <li><span class="kbd">ageEstimator.onUpdate</span> 콜백으로 (연령대) → UI 프리셋 적용</li>
      <li>예: <span class="kbd">65+</span> ⇒ 글자·버튼 1.4배, 고대비, 단계 단순화</li>
    </ul>
    <pre id="emitJson" style="white-space:pre-wrap; word-break:break-all; background:#0f0f11; border:1px solid #222; border-radius:8px; padding:8px; font-size:.9rem;"></pre>
  </div>
</main>

<!-- 1) TF.js + FaceAPI (TF.js 내장 번들) -->
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.15/dist/face-api.js"></script>
<script>
(function(){
  const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.15/model'; // weights on CDN
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx2d = overlay.getContext('2d');

  const ui = {
    modelInfo: document.getElementById('modelInfo'),
    backendInfo: document.getElementById('backendInfo'),
    fpsInfo: document.getElementById('fpsInfo'),
    ageVal: document.getElementById('ageVal'),
    genderVal: document.getElementById('genderVal'),
    bucketVal: document.getElementById('bucketVal'),
    confVal: document.getElementById('confVal'),
    emitJson: document.getElementById('emitJson'),
    btnStart: document.getElementById('btnStart'),
    btnStop: document.getElementById('btnStop')
  };

  // 간단 FPS 측정
  let lastTs = performance.now(), fpsEMA = 0;
  function tickFPS(){
    const now = performance.now();
    const dt = now - lastTs; lastTs = now;
    const fps = 1000 / Math.max(dt, 1);
    fpsEMA = fpsEMA ? (fpsEMA*0.9 + fps*0.1) : fps;
    ui.fpsInfo.textContent = fpsEMA.toFixed(1);
  }

  // 나이 안정화(지수 이동평균 + 최근 N 중앙값)
  const buf = [];
  function smoothAge(raw){
    if (!isFinite(raw)) return null;
    buf.push(raw);
    if (buf.length > 15) buf.shift();
    const recent = buf.slice(-7).sort((a,b)=>a-b);
    const median = recent[Math.floor(recent.length/2)];
    return median*0.7 + mean(buf)*0.3;
  }
  const mean = arr => arr.reduce((a,b)=>a+b,0) / arr.length;

  // 연령대 버킷
  function toBucket(age){
    if (age == null) return '-';
    if (age >= 65) return '65+';
    if (age >= 40) return '40–64';
    return '≤39';
  }

  // 최대 박스 선택(멀티페이스 중 가장 큰 얼굴)
  function pickLargest(results){
    if (!results || results.length===0) return null;
    return results.sort((a,b)=>{
      const ar = a.detection.box; const br = b.detection.box;
      return (br.width*br.height) - (ar.width*ar.height);
    })[0];
  }

  // 외부에 제공할 콜백 훅
  const ageEstimator = {
    onUpdate: null,   // (payload) => {}
    last: null
  };
  window.ageEstimator = ageEstimator; // 키오스크 코드에서 접근 가능

  // 메인 루프
  let loopId = null, stream = null;

  async function setupModels(){
    ui.modelInfo.textContent = '모델 로딩 중…';
    // 경량 탐지기 + 나이/성별 네트워크
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL);
    ui.modelInfo.textContent = 'tinyFaceDetector + ageGenderNet';
    ui.backendInfo.textContent = faceapi.tf?.engine()?.backendName || 'tfjs';
  }

  async function start(){
    ui.btnStart.disabled = true;
    ui.btnStop.disabled = false;

    await setupModels();

    // 카메라 시작
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width:{ideal:1280}, height:{ideal:720} }, audio:false });
    } catch (e){
      alert('카메라 권한을 허용해 주세요.');
      ui.btnStart.disabled = false; ui.btnStop.disabled = true;
      return;
    }

    video.srcObject = stream;
    await video.play();

    // 캔버스 크기 동기화
    overlay.width = video.videoWidth || video.clientWidth;
    overlay.height = video.videoHeight || video.clientHeight;

    const opts = new faceapi.TinyFaceDetectorOptions({ inputSize: 256, scoreThreshold: 0.5 });

    // 추론 루프
    const loop = async () => {
      tickFPS();
      const dets = await faceapi.detectAllFaces(video, opts).withAgeAndGender();
      ctx2d.clearRect(0,0,overlay.width, overlay.height);

      if (dets && dets.length){
        const best = pickLargest(dets);
        const { age, gender, genderProbability, detection } = best;
        // 시각화
        faceapi.draw.drawDetections(overlay, [detection]);
        const ageSmoothed = smoothAge(age);
        const bucket = toBucket(ageSmoothed);

        ui.ageVal.textContent = ageSmoothed ? `${ageSmoothed.toFixed(1)} 세` : '—';
        ui.genderVal.textContent = `${gender} (${(genderProbability*100).toFixed(0)}%)`;
        ui.bucketVal.textContent = bucket;
        // 간단 신뢰도: 얼굴 검출 점수와 버퍼 길이 기반
        const conf = Math.min(1, (best.detection.score||0)*0.7 + Math.min(buf.length/15,1)*0.3);
        ui.confVal.textContent = `${Math.round(conf*100)}%`;

        // 외부 전달 페이로드
        const payload = {
          ageRaw: age, age: ageSmoothed, bucket,
          gender, genderProb: genderProbability,
          conf, ts: Date.now()
        };
        ageEstimator.last = payload;
        if (typeof ageEstimator.onUpdate === 'function') ageEstimator.onUpdate(payload);
        ui.emitJson.textContent = JSON.stringify(payload, null, 2);
      } else {
        ui.ageVal.textContent = '—'; ui.genderVal.textContent = '—'; ui.bucketVal.textContent = '—';
        ui.emitJson.textContent = '';
      }

      loopId = requestAnimationFrame(loop);
    };
    loopId = requestAnimationFrame(loop);
  }

  function stop(){
    if (loopId) { cancelAnimationFrame(loopId); loopId = null; }
    if (stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
    ui.btnStart.disabled = false;
    ui.btnStop.disabled = true;
    ctx2d.clearRect(0,0,overlay.width, overlay.height);
  }

  ui.btnStart.addEventListener('click', start);
  ui.btnStop.addEventListener('click', stop);
})();
</script>
</body>
</html>
